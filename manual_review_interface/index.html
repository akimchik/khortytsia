<!DOCTYPE html>
<html>
<head>
  <title>Khortytsia - Manual Review</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; color: #333; max-width: 960px; margin: 20px auto; }
    .container { width: 95%; margin: 0 auto; }
    h1 { text-align: center; color: #222; }
    .analysis { border: 1px solid #ccc; border-radius: 8px; padding: 20px; margin-bottom: 20px; background-color: #f9f9f9; }
    .form-group { margin-bottom: 15px; }
    label { display: block; font-weight: bold; margin-bottom: 5px; }
    input, textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
    textarea { min-height: 100px; }
    button { background-color: #28a745; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
    button:hover { background-color: #218838; }
    #config { background-color: #fffbe6; border: 1px solid #ffe58f; border-radius: 8px; padding: 20px; margin-bottom: 30px; }
    #config h2 { margin-top: 0; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Khortytsia - Manual Review Queue</h1>

    <div id="config">
      <h2>Configuration</h2>
      <p>After deploying with Terraform, get the function URLs by running <code>terraform output</code> and paste them here.</p>
      <div class="form-group">
        <label for="get_url">get_manual_review Function URL</label>
        <input type="text" id="get_url" placeholder="Paste URL here">
      </div>
      <div class="form-group">
        <label for="submit_url">submit_correction Function URL</label>
        <input type="text" id="submit_url" placeholder="Paste URL here">
      </div>
       <button onclick="getAnalyses()">Load Review Queue</button>
    </div>

    <div id="analyses"></div>
  </div>

  <script>
    // --- CONFIGURATION ---
    // After deploying, run `terraform output` and paste the URLs here.
    const CONFIG = {
        GET_MANUAL_REVIEW_URL: '',
        SUBMIT_CORRECTION_URL: ''
    };

    function updateConfig() {
        CONFIG.GET_MANUAL_REVIEW_URL = document.getElementById('get_url').value;
        CONFIG.SUBMIT_CORRECTION_URL = document.getElementById('submit_url').value;
    }

    async function getAnalyses() {
      updateConfig();
      if (!CONFIG.GET_MANUAL_REVIEW_URL) {
        alert('Please configure the get_manual_review Function URL first.');
        return;
      }

      const analysesDiv = document.getElementById('analyses');
      analysesDiv.innerHTML = 'Loading...';

      try {
        const response = await fetch(CONFIG.GET_MANUAL_REVIEW_URL);
        const analyses = await response.json();
        analysesDiv.innerHTML = '';

        if (analyses.length === 0) {
            analysesDiv.innerHTML = '<p>Review queue is empty. Great job!</p>';
            return;
        }

        for (const analysis of analyses) {
          const analysisDiv = document.createElement('div');
          analysisDiv.classList.add('analysis');
          analysisDiv.innerHTML = `
            <h2>${analysis.companyName}</h2>
            <p><strong>Source:</strong> <a href="${analysis.sourceURL}" target="_blank">${analysis.sourceURL}</a></p>
            <form onsubmit="submitCorrection(event, '${analysis.id}')">
              <div class="form-group">
                <label>Company Name</label>
                <input type="text" name="companyName" value="${analysis.companyName}">
              </div>
              <div class="form-group">
                <label>Industry</label>
                <input type="text" name="industry" value="${analysis.industry}">
              </div>
              <div class="form-group">
                <label>Region</label>
                <input type="text" name="region" value="${analysis.region}">
              </div>
              <div class="form-group">
                <label>Opportunity Type</label>
                <input type="text" name="opportunityType" value="${analysis.opportunityType}">
              </div>
              <div class="form-group">
                <label>Summary</label>
                <textarea name="summary">${analysis.summary}</textarea>
              </div>
              <div class="form-group">
                <label>Potential Need</label>
                <textarea name="potentialNeed">${analysis.potentialNeed.join('\n')}</textarea>
              </div>
              <div class="form-group">
                <label>Opportunity Score</label>
                <input type="number" name="opportunityScore" value="${analysis.opportunityScore}">
              </div>
              <div class="form-group">
                <label>Key Quote</label>
                <textarea name="keyQuote">${analysis.keyQuote}</textarea>
              </div>
              <button type="submit">Submit Correction</button>
            </form>
          `;
          analysesDiv.appendChild(analysisDiv);
        }
      } catch (error) {
        analysesDiv.innerHTML = `<p style="color: red;"><strong>Error:</strong> Could not load review queue. Is the URL correct? (${error.message})</p>`;
      }
    }

    async function submitCorrection(event, id) {
      event.preventDefault();
      updateConfig();
      if (!CONFIG.SUBMIT_CORRECTION_URL) {
        alert('Please configure the submit_correction Function URL first.');
        return;
      }

      const form = event.target;
      const formData = new FormData(form);
      const correctedAnalysis = {
        id,
        companyName: formData.get('companyName'),
        industry: formData.get('industry'),
        region: formData.get('region'),
        opportunityType: formData.get('opportunityType'),
        summary: formData.get('summary'),
        potentialNeed: formData.get('potentialNeed').split('\n'),
        opportunityScore: parseInt(formData.get('opportunityScore')),
        keyQuote: formData.get('keyQuote'),
      };

      try {
        const response = await fetch(CONFIG.SUBMIT_CORRECTION_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(correctedAnalysis),
        });
        if (!response.ok) {
            throw new Error(`Server responded with status: ${response.status}`);
        }
        alert('Correction submitted successfully!');
        getAnalyses();
      } catch (error) {
        alert(`Error submitting correction: ${error.message}`);
      }
    }
  </script>
</body>
</html>